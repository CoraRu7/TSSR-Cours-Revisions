# Fiche – Gérer des snapshots sous Hyper-V

## I) Checkpoints Hyper-V : définition et types

### Contexte

* Les snapshots (ou checkpoints) Hyper-V sont des **instantanés d’une VM** à un moment précis.
* Utilité : tester des mises à jour, installer des logiciels, modifier des configurations sans risquer l’intégrité des données.
* **Important :** Les snapshots ne remplacent pas une **sauvegarde complète**.

### Qu’est-ce qu’un disque dur virtuel ?

* Fonctionne comme un disque physique : créer fichiers, dossiers, partitionner, héberger un OS ou des applications.
* Types :

  1. **Disque virtuel en ligne** – accessible via Internet.
  2. **Disque RAM** – utilise la mémoire vive de l’ordinateur pour simuler un stockage.

### Types de checkpoints Hyper-V

1. **Standard** (anciennement snapshot)

   * Capture l’état de la VM et sa mémoire.
   * Ne garantit pas la cohérence des applications (risque pour AD, SQL, Exchange).
2. **Production** (activé par défaut)

   * Sauvegarde cohérente via **Volume Shadow Copy** (Windows) ou **File System Freeze** (Linux).
   * Pas de snapshot de mémoire.
   * En cas d’échec, un checkpoint standard est pris.

---

## II) Gestion des checkpoints

### Modifier le type de checkpoint

* **Hyper-V Manager :**

  1. Clic droit sur la VM → Paramètres → Management → Checkpoints.
  2. Sélectionner le type de checkpoint.
* **PowerShell :**

```powershell
# Standard
Set-VM -Name <vmname> -CheckpointType Standard

# Production
Set-VM -Name <vmname> -CheckpointType Production

# Production uniquement
Set-VM -Name <vmname> -CheckpointType ProductionOnly
```

### Créer un checkpoint

* **Hyper-V Manager :** clic droit sur VM → Checkpoint.
* **PowerShell :**

```powershell
Checkpoint-VM -Name <VMName>
Get-VMCheckpoint -VMName <VMName>  # Liste des checkpoints
```

### Restaurer une VM

* **Hyper-V Manager :** clic droit sur checkpoint → Appliquer ou Créer un checkpoint et Appliquer.
* **PowerShell :**

```powershell
Restore-VMCheckpoint -Name <CheckpointName> -VMName <VMName> -Confirm:$false
```

### Supprimer un checkpoint

* **Hyper-V Manager :** clic droit → Delete Checkpoint ou Delete Checkpoint Subtree.
* Fusionne les fichiers .avhdx dans le disque parent (.vhdx).

### Activer/Désactiver et configurer le stockage

* **Hyper-V Manager :** Paramètres VM → Checkpoints → Enable Checkpoints / Checkpoint File Location.

### Renommer un checkpoint

* **Hyper-V Manager :** clic droit → Renommer.
* **PowerShell :**

```powershell
Rename-VMCheckpoint -VMName <VMName> -Name <OldName> -NewName <NewName>
```

---

## III) Fusion des snapshots

### Principe

* Les snapshots créent des **disques de différenciation (.avhdx)** liés au disque parent (.vhdx).
* Fusion nécessaire pour économiser de l’espace et améliorer les performances.
* **Règle :** fusionner **de l’enfant au parent** (plus récent → plus ancien).
* VM doit être **éteinte** pendant la fusion.

### Méthode Hyper-V Manager

1. Ouvrir Hyper-V Manager → Inspecter le disque → Identifier l’ordre parent-enfant.
2. Éditer le disque → Choisir l’action « Fusionner » → Vers le disque parent.
3. Répéter pour chaque fichier .avhdx → Redémarrer VM.

### Méthode PowerShell

1. Activer la cmdlet Merge-VHD si nécessaire :

```powershell
Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V-Management-PowerShell
```

2. Fusionner :

```powershell
Merge-VHD -Path <chemin_du_disque_enfant> -DestinationPath <chemin_disque_parent>
```

> Astuce : PowerShell fusionne toute la chaîne en une seule commande, contrairement à Hyper-V Manager.

---

## IV) Bonnes pratiques

* Utiliser les snapshots **principalement en développement/test**, pas en production.
* Les snapshots ne remplacent pas une **solution de sauvegarde fiable**.
* Limiter le nombre de snapshots pour éviter les problèmes de performance et de stockage.

---

## V) Essentiel

* Les snapshots Hyper-V (checkpoints) sauvegardent l’état, les données et la configuration d’une VM à un moment précis.
* Permettent de **revenir à un état antérieur** en cas d’erreur.
* Deux types : **standard** (mémoire incluse) et **production** (cohérence applicative).
* Gestion via **Hyper-V Manager** ou **PowerShell** : création, restauration, suppression, fusion et configuration.
* Fusionner les snapshots régulièrement pour maintenir les performances et l’espace disque.

---