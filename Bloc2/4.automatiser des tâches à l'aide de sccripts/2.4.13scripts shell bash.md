# **Adaptation des scripts Shell Bash : Surveillance et automatisation**

## **Objectif**

Apprendre à surveiller un serveur Web (ex. Apache) avec Bash, détecter les pannes via le code HTTP et automatiser le redémarrage des services critiques avec journalisation et planification cron.

---

## **Concepts clés**

### **1. Surveillance de l’état du serveur**

* **Problématique** : services critiques doivent rester opérationnels (ex. système de vente).
* **Principe** : vérifier le code HTTP renvoyé par le serveur pour savoir si une page est accessible.

**Codes HTTP importants :**

* `200` : OK, tout fonctionne.

* `404` : page non trouvée.

* `500` : erreur interne serveur.

* **Commande curl pour vérifier le code HTTP :**

```bash
curl --write-out %{http_code} --silent --output /dev/null www.monserveur.fr
```

* Attribuer le code HTTP à une variable pour traitement :

```bash
code_http=$(curl --write-out %{http_code} --silent --output /dev/null www.monserveur.fr)
```

---

### **2. Script Bash pour redémarrage automatique**

**Fichier** : `verification_serveur.sh`

**Structure de base :**

```bash
#!/bin/bash

# Vérification du code HTTP
code_http=$(curl --write-out %{http_code} --silent --output /dev/null www.monserveur.fr)

# Si le serveur ne répond pas correctement
if [ $code_http -ne 200 ]; then
    # Écrire un message dans le journal avec date et heure
    echo "Problème avec le serveur en le redémarrant $(date +%F\ %T)" >> /script/serveur.log
    
    # Redémarrer le serveur Apache
    systemctl restart httpd
fi
```

**Notes importantes :**

* Vérifier le nom du service selon le système (`http` ou `httpd`).
* Assurer les droits d’écriture sur le fichier log (`/script/serveur.log`).
* La date et l’heure peuvent être obtenues avec `$(date +%F\ %T)`.

---

### **3. Automatisation avec cron**

* **cron** : planificateur de tâches sous Linux.
* **Commandes utiles :**

  * `crontab -e` : éditer le fichier de planification.
  * `crontab -l` : lister les tâches existantes.
  * `service cron start` / `systemctl status cron` : démarrer ou vérifier le service cron.

**Exemple de planification : exécution toutes les minutes**

```bash
*/1 * * * * bash /scripts/verification_serveur.sh
```

* Colonnes cron : `minutes / heures / jour du mois / mois / jour de la semaine / commande`.

---

### **4. Bonnes pratiques**

* Tester le script manuellement avant automatisation :

```bash
./verification_serveur.sh
```

* Journaliser les événements pour audit et suivi.
* Automatiser uniquement des actions sûres, éviter d’exécuter des commandes non validées par l’utilisateur.

---

### **Flashcards**

* **curl** : transférer des données entre serveur et hôte, récupérer le code HTTP.
* **cron** : exécuter automatiquement des scripts selon un planning.
* **bash** : interpréteur pour exécuter des scripts Shell sous Linux.
* **systemctl restart httpd** : redémarrer le service Apache.

---

### **Synthèse**

* L’adaptation des scripts Shell Bash permet de **surveiller un serveur Web**, détecter les erreurs via **codes HTTP**, et automatiser les actions correctives avec **cron**.
* Utiliser **journalisation** et bonnes pratiques Bash pour fiabilité et sécurité.

---