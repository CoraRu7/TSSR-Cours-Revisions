# **PowerShell – Administration Active Directory**

## **Objectif**

Savoir créer, gérer et supprimer des utilisateurs et groupes Active Directory via PowerShell, et gérer les erreurs lors des opérations.

---

## **Concepts clés**

### **1. Préparation**

* **Installer le module Active Directory** :

```powershell
Import-Module ActiveDirectory
```

* Permet d’accéder à toutes les commandes PowerShell liées à AD.

---

### **2. Gestion des utilisateurs**

#### **Créer un utilisateur simple**

```powershell
New-ADUser J.Dupont
```

* Compte créé par défaut :

  * Dans le répertoire "Users"
  * Désactivé
  * Membre du groupe "Utilisateur du domaine"
  * Pas de mot de passe configuré

#### **Activer un utilisateur**

```powershell
Enable-ADAccount -Identity "CN=Christian,CN=Users,DC=studi,DC=local"
```

#### **Créer un utilisateur avec des propriétés complètes**

```powershell
New-ADUser -Name "Marc Smith" -GivenName "Marc" -Surname "Smith" -SamAccountName "Marc.Smith" `
-UserPrincipalName "Marc.Smith@studi.com" -Path "CN=Users,DC=studi,DC=com" `
-AccountPassword (Read-Host -AsSecureString "Input Password") -Enabled $true
```

#### **Vérifier un utilisateur**

```powershell
Get-ADUser J.Dupont -Properties CanonicalName, Enabled, GivenName, Surname, Name, UserPrincipalName, samAccountName, whenCreated, PasswordLastSet | 
Select CanonicalName, Enabled, GivenName, Surname, Name, UserPrincipalName, samAccountName, whenCreated, PasswordLastSet
```

#### **Créer un script interactif**

* **Variables via `Read-Host`** pour prénom, nom, département, OU cible
* **Login automatique** : `prenom.nom`
* Vérification si l’OU existe avant création
* Demande de mot de passe sécurisé : `Read-Host -AsSecureString`

---

### **3. Gestion des groupes**

#### **Lister les commandes pour les groupes**

```powershell
Get-Command -Module ActiveDirectory -Name "*Group*"
```

#### **Créer un groupe simple**

```powershell
New-ADGroup "GroupeStudi"
```

#### **Créer un groupe avec paramètres**

```powershell
New-ADGroup "Compta" -Path "DC=studi,DC=com" -GroupCategory Security -GroupScope Global -PassThru -Verbose
```

#### **Ajouter un utilisateur à un groupe**

```powershell
Add-ADGroupMember -Identity Compta -Members J.Dupont
```

#### **Supprimer un utilisateur d’un groupe**

```powershell
Remove-ADGroupMember -Identity Compta -Members J.Dupont
```

---

### **4. Gestion des erreurs**

#### **Paramètres `-ErrorAction` et `-ErrorVariable`**

```powershell
Get-ADUser "UtilisateurInexistant" -ErrorAction Stop -ErrorVariable erreurAD
```

* `-ErrorAction Stop` : arrête l’exécution si erreur
* `-ErrorVariable` : stocke l’erreur dans une variable

#### **Bloc Try / Catch / Finally**

```powershell
Try {
    $user = Get-ADUser "J.Dupont"
    Write-Host "Utilisateur trouvé : $($user.Name)"
}
Catch {
    Write-Host "Erreur : utilisateur non trouvé"
}
Finally {
    Write-Host "Recherche terminée"
}
```

* **Try** : exécute la commande
* **Catch** : capture l’erreur
* **Finally** : s’exécute toujours, succès ou échec

---

### **5. Essentiel à retenir**

1. `Import-Module ActiveDirectory` → activer le module AD
2. `New-ADUser` → créer un utilisateur
3. `Enable-ADAccount` → activer un utilisateur
4. `Get-ADUser` → vérifier un utilisateur
5. `New-ADGroup` → créer un groupe
6. `Add-ADGroupMember` → ajouter un utilisateur à un groupe
7. `Remove-ADGroupMember` → retirer un utilisateur d’un groupe
8. `Try/Catch/Finally` + `-ErrorAction` / `-ErrorVariable` → gérer les erreurs

---