# Fiche — **Introduction au serveur Syslog & NTP**

Résumé clair, procédures pas-à-pas et commandes (Debian 11 / CentOS-like exemples)

---

## Objectif

Centraliser et analyser les logs (Syslog) et assurer une synchronisation temporelle fiable (NTP) pour garantir traçabilité, corrélation d’événements et fonctionnement correct des tâches planifiées / clusters.

---

## 1) Concepts rapides

**Syslog**

* Protocole normalisé (RFC 3164 / 5424…), port **514/UDP** (et 514/TCP possible).
* Permet d’envoyer des messages de tous les équipements/OS vers un collecteur central (serveur syslog).
* Avantages : centralisation, corrélation, conservation, alerting, conformité (RGPD/ANSSI à respecter).

**NTP (Network Time Protocol)**

* Synchronisation horaire réseau (RFC 5905). Port **123/UDP**.
* Important pour l’horodatage des logs, réplication, sauvegardes, clustering.
* Sur Debian 11 on utilise souvent **chrony** (remplaçant moderne), mais **ntp** est aussi disponible.

---

## 2) Architecture recommandée (simple)

* **Serveur Syslog central** (Debian 11) : rsyslog + base SQL (rsyslog-mysql) + LogAnalyzer (UI web).
* **Clients** (Linux/Windows/équipement réseau) : envoient logs via UDP/TCP ou via transport sécurisé (TLS / RELP / VPN).
* **Serveur NTP** (peut être le même ou séparé) : chrony ou ntpd, distribue l’heure aux clients.

---

## 3) Mise en œuvre — Serveur Syslog (Debian 11) — procédure pas à pas

### A. Préparer le système (root)

```bash
# devenir root
su -
# mettre à jour
apt update && apt upgrade -y
```

### B. Installer LAMP et dépendances pour LogAnalyzer

```bash
apt install -y apache2 mariadb-server php php-mysql php-gd php-cli
```

### C. Installer rsyslog + support MySQL

```bash
apt install -y rsyslog rsyslog-mysql
```

Pendant l’installation `rsyslog-mysql` propose de créer une base SQL (accepter « Yes »). On définit alors un mot de passe pour l’utilisateur MySQL `rsyslog` — **retient-le**.

> Si MySQL/MariaDB demande sécurisation :

```bash
mysql_secure_installation
```

### D. Activer l’écoute réseau syslog (TCP/UDP 514)

Édite `/etc/rsyslog.conf` (ou `/etc/rsyslog.d/50-default.conf`) et **décommente / ajoute** les modules d’écoute :

**syntax moderne (rsyslog v8)** :

```conf
module(load="imuxsock")    # déjà présent
module(load="imklog")      # kernel logging

# UDP
module(load="imudp")
input(type="imudp" port="514")

# TCP
module(load="imtcp")
input(type="imtcp" port="514")
```

### E. Enregistrer les logs dans MySQL

Ajoute à la fin de `/etc/rsyslog.conf` (ou dans un fichier `/etc/rsyslog.d/50-sql.conf`) :

```
*.* :ommysql:localhost,Syslog,rsyslog,MOT_DE_PASSE_RSYSLOG
```

> Remplace `MOT_DE_PASSE_RSYSLOG` par le mot de passe choisi lors de l’installation.

### F. Redémarrer rsyslog

```bash
systemctl restart rsyslog
systemctl status rsyslog
```

### G. Tester l’envoi local

```bash
logger "TEST SYSLOG - serveur central"
tail -n 50 /var/log/syslog
```

---

## 4) Installer LogAnalyzer (UI web) — procédure rapide

### A. Téléchargement & préparation

```bash
cd /srv
wget https://download.adiscon.com/loganalyzer/loganalyzer-4.1.12.tar.gz
tar -zxvf loganalyzer-4.1.12.tar.gz
mkdir -p /var/www/html/syslogweb
cp -a /srv/loganalyzer-4.1.12/src/* /var/www/html/syslogweb
chown -R www-data:www-data /var/www/html/syslogweb
```

### B. Accéder à l’installateur web

Ouvrir `http://<IP-du-serveur>/syslogweb` → suivre l’assistant :

1. Next → vérification prérequis.
2. **Enable User Database** : Yes.
3. Paramètres BD : DB name `Syslog`, user `rsyslog`, mot de passe défini plus tôt.
4. Créer user admin pour l’interface LogAnalyzer.
5. Source de logs : choisir **MYSQL Native** et renseigner la DB `Syslog`/`rsyslog`.
6. Finish → accès interface.

---

## 5) Configurer clients (Linux & Windows) pour envoyer vers le serveur

### A. Client Linux (rsyslog)

Éditer `/etc/rsyslog.conf` ou `/etc/rsyslog.d/50-remote.conf` :

* **UDP** : `*.* @192.168.1.100:514`
* **TCP** (préférable) : `*.* @@192.168.1.100:514`  (double @ pour TCP)

Puis redémarrer :

```bash
systemctl restart rsyslog
logger "message de test client vers serveur syslog"
```

### B. Client Windows (Event Forwarding / SNARE / nxlog / syslog agent)

* Installer un agent (nxlog, Snare).
* Configurer destination `192.168.1.100:514` (UDP ou TCP), communauté/credentials si TLS/REL P.
* Activer et tester.

---

## 6) Sécurité & conformité (RGPD / ANSSI) — recommandations

* **Limiter accès** : n’autoriser que les IP des pollers/clients (firewall).
* **Utiliser TLS / RELP** : rsyslog supporte TLS (module `imtcp` + TLS config) ou **omrelp/imrelp** pour transport fiable chiffré.
* **Masquer / anonymiser** données sensibles dans les logs si nécessaire (politique RGPD).
* **Retention** : définir politique de rétention (logrotate, purge DB) et conserver preuves de suppression.
* **Audits et accès** : restreindre l’UI (LogAnalyzer) à comptes autorisés, activer HTTPS.
* **Backups** : sauvegarde de la base `Syslog` régulièrement (`mysqldump`).

---

## 7) Log rotation & performances

* Rsyslog écrit aussi fichiers sur disque → utiliser `/etc/logrotate.d/rsyslog` pour gérer taille/rotation.
* Stockage en DB : surveiller taille, mettre index, partitionner si gros volume.
* Pour gros volumes : utiliser filebeat/ELK/Graylog/rsyslog → architecture distribuée.

---

## 8) Vérifications utiles / commandes de debug

**Sur serveur syslog**

```bash
# suivre logs rsyslog
tail -f /var/log/syslog

# vérifier écoute port syslog
ss -lnup | grep 514
ss -lntp | grep 514

# vérifier tables BD (exemple)
mysql -u rsyslog -p -e "USE Syslog; SHOW TABLES; SELECT COUNT(*) FROM SystemEvents LIMIT 1;"
```

**Sur client**

```bash
logger "test vers serveur central"
# tracer les paquets syslog
tcpdump -i any port 514 -vv
```

---

## 9) NTP — installation & configuration (chrony recommandé sur Debian 11)

### A. Installer chrony

```bash
apt install -y chrony
```

### B. Configurer le serveur NTP (exposer comme serveur interne)

Éditer `/etc/chrony/chrony.conf` — ajouter pools / allow subnet :

```conf
# serveurs publics (ex. France)
pool 0.fr.pool.ntp.org iburst
pool 1.fr.pool.ntp.org iburst

# autoriser clients du réseau local (ex. 192.168.1.0/24)
allow 192.168.1.0/24
```

### C. Redémarrer et vérifier

```bash
systemctl restart chrony
chronyc sources -v
chronyc tracking
timedatectl status
```

### D. Client pointant vers serveur interne

Sur clients Debian → `/etc/chrony/chrony.conf` :

```
server <IP-serveur-chrony> iburst
```

Puis `systemctl restart chrony` sur le client.

### E. Firewall

Autoriser NTP :

```bash
# ufw example
ufw allow 123/udp
```

---

## 10) Tests & bonnes pratiques NTP

* `chronyc sources` pour vérifier sources et état.
* `chronyc tracking` pour offset/leap/time accuracy.
* Garder plusieurs upstream public pools (redundance).
* Ne pas exposer un serveur NTP non restreint vers Internet (risque d’abus/DDoS via amplification).

---

## 11) Checklist déploiement rapide

* [ ] rsyslog installé & écoute TCP/UDP 514.
* [ ] Base MySQL `Syslog` créée et user `rsyslog` configuré.
* [ ] Rsyslog écrit dans la BD (`ommysql`) ou fichier + LogAnalyzer connecté.
* [ ] LogAnalyzer installé et accessible (Apache + PHP).
* [ ] Clients configurés (rsyslog/nxlog) pour envoyer vers le collecteur.
* [ ] Transport sécurisé (REL P/TLS) si logs sensibles.
* [ ] chrony installé & configuré sur le serveur ; clients pointent dessus.
* [ ] Firewall autorise 514 (si nécessaire) et 123/UDP (NTP) entre composants autorisés.
* [ ] Politique de rétention / logrotate / sauvegarde définie.
* [ ] Conformité RGPD & ANSSI prise en compte (accès, durée de conservation, anonymisation).

---

## Ressources / commandes récapitulatives utiles

* `systemctl restart rsyslog` — redémarrer rsyslog
* `tail -f /var/log/syslog` — suivre logs locaux
* `logger "message"` — envoyer message syslog local / test
* `ss -lnup | grep 514` — vérifier écoute syslog UDP/TCP
* `apt install chrony` / `systemctl restart chrony` — installer / redémarrer NTP
* `chronyc sources -v` / `chronyc tracking` — vérifier NTP

---

Si tu veux, je te fournis :

1. un **playbook shell** (script) pour automatiser l’installation rsyslog+mysql+loganalyzer (Debian 11) ;
2. un **exemple de configuration rsyslog TLS/REL P** pour transport sécurisé ;
3. un **template Logrotate** adapté à une volumétrie donnée.

Lequel préfères-tu en suivant ?
