# Fiche — **Installation de Centreon / Nagios** (procédures étape-par-étape)

* **A** — installation *Centreon* (déploiement central + DB) sur CentOS 7 (méthode image/VM ou repo) — adaptée à la démo vidéo que tu as décrite.
* **B** — installation *Nagios Core* minimale sur une machine Ubuntu (pour apprendre le fonctionnement « à la racine »).

> ⚠️ Remarque importante : les commandes exactes (paquets, noms de dépôts) peuvent varier selon la version.

---

## A — **Centreon** (Central + Database) — procédure pas à pas (CentOS 7)

> But : installer Centreon central (engine + broker + web + DB) sur une VM CentOS 7, accéder à l’UI web pour finaliser la configuration.

### 0) Pré-requis machine / VM

* CentOS 7 installé (64-bit), accès `root`, interface réseau fonctionnelle.
* Ressources recommandées : 2 vCPU, 4–8 GB RAM, 40+ GB disque pour tests.
* Accès internet pour installer paquets.
* SGBD : MariaDB/MySQL (installer via le déroulé Centreon ou préinstaller).

### 1) Mettre à jour le système

```bash
# en root
yum -y update
reboot   # si noyau mis à jour
```

### 2) Paramètres réseau & hostname

```bash
# vérifier IP
ip a

# définir hostname (ex : centreon01.example.local)
hostnamectl set-hostname centreon01.example.local
```

Vérifie que l’IP est accessible depuis ton poste (ex : `ping <IP>`).

### 3) Sécuriser MySQL et créer mot de passe root MySQL

Si MariaDB/MySQL n’est pas encore installé, tu peux laisser Centreon l’installer, sinon :

```bash
# installer MariaDB (exemple si tu veux gérer la DB avant)
yum -y install mariadb-server
systemctl enable --now mariadb

# sécuriser MySQL
mysql_secure_installation
# -> choisis un mot de passe root MySQL et réponds aux autres questions par défaut/YES
```

### 4) Ouvrir ports firewall nécessaires (HTTP/HTTPS, SNMP, NRPE si besoin)

```bash
# exemple : activer HTTP/HTTPS et SNMP
firewall-cmd --permanent --add-service=http
firewall-cmd --permanent --add-service=https
firewall-cmd --permanent --add-port=161/udp    # SNMP si utile
firewall-cmd --reload
```

### 5) Installer dépendances de base (Apache, PHP, MariaDB client, outils)

```bash
yum -y install httpd php php-mysqlnd php-gd php-xml php-mbstring mariadb
systemctl enable --now httpd
```

### 6) Télécharger / préparer Centreon

Deux méthodes courantes :

* **A.** utiliser l’ISO/OVA (VM pré-packagée) fournie par Centreon → recommandé si tu veux gagner du temps (tu déploies la VM, tu suis l’installeur web).
* **B.** installer via les dépôts officiels Centreon.

**Méthode image (ISO/OVA)** — procédure rapide (comme dans ta vidéo) :

1. Télécharger l’OVA/ISO Centreon depuis le site officiel.
2. Importer la VM dans ton hyperviseur (VirtualBox/VMware).
3. Démarrer la VM, suivre l’installateur CentOS + Centreon (choix *Central with database*), définir `root` puis compléter la configuration web depuis un navigateur pointant vers l’IP affichée.

**Méthode dépôt (extraits génériques)** — si tu veux installer via yum/repos :

```bash
# exemple générique — les repo réels peuvent demander une URL spécifique de Centreon
# ajouter repo (ex. /etc/yum.repos.d/centreon.repo)
cat > /etc/yum.repos.d/centreon.repo <<'EOF'
[centreon]
name=Centreon repo
baseurl=http://packages.centreon.com/centreon/7/
gpgcheck=0
enabled=1
EOF

yum clean all
yum -y install centreon centreon-web centreon-engine centreon-broker
```

> **Note** : Centreon fournit un *installer web*/wizard que tu lances en pointant ton navigateur vers `http://<IP>/centreon`. L’installateur gui t’accompagne pour créer la BDD et l’utilisateur `admin`.

### 7) Lancer l’interface web d’installation (si méthode dépôt/image)

* Ouvre un navigateur et entre l’adresse IP de la machine (ex : `http://172.21.65.68`).
* L’installateur web te guide (étapes 1→4) : création du compte `admin`, saisie du mot de passe MySQL créé précédemment, installation modules, base.
* Clique **Install** puis **Finish**.
* Connecte-toi à l’UI avec `admin` + mot de passe créé.

### 8) Post-installation & vérification

* Vérifier services : `systemctl status centreon` (ou `centengine`, `centreon-broker`, `httpd`, `mariadb`)
* Vérifier logs : `/var/log/centreon/` ou `/var/log/messages` selon l’install.
* Depuis l’UI : ajouter un hôte test, créer un service (ping), vérifier remontée de l’état.

### 9) Sauvegarde / bonnes pratiques

* **Sécurise** l’UI : activer HTTPS (certificat), restreindre accès par IP.
* **SNMP** : configurer SNMPv3 sur équipements et utiliser `check_snmp` pour les checks réseau.
* **Agents** : installer NRPE sur serveurs Linux à superviser et WMI sur Windows si besoin.
* Sauvegarde DB : `mysqldump centreon > /backup/centreon.sql`.

---

## B — **Nagios Core** (installation minimale sur Ubuntu) — procédure pas à pas

> But : installer Nagios Core + Nagios Plugins + NRPE minimal pour tester checks.

### 0) Pré-requis

* Machine Ubuntu (ex. 20.04/22.04) avec `sudo` et accès internet.

### 1) Installer dépendances

```bash
sudo apt update
sudo apt -y upgrade

# paquets requis
sudo apt -y install build-essential libgd-dev unzip apache2 php libapache2-mod-php7.4
# ajuster php version si nécessaire
```

### 2) Créer utilisateur nagios et groupe

```bash
sudo useradd nagios
sudo useradd nagcmd
sudo usermod -aG nagcmd nagios
sudo usermod -aG nagcmd www-data
```

### 3) Télécharger et compiler Nagios Core

```bash
cd /tmp
# télécharge la dernière version stable (numéro peut varier)
wget https://assets.nagios.com/downloads/nagioscore/releases/nagios-4.x.x.tar.gz
tar zxvf nagios-4*.tar.gz
cd nagios-4*/
./configure --with-command-group=nagcmd
make all
sudo make install
sudo make install-init
sudo make install-config
sudo make install-commandmode
sudo make install-webconf
```

(les numéros peuvent changer : suppléer par la version exacte)

### 4) Installer Nagios plugins

```bash
cd /tmp
wget https://nagios-plugins.org/download/nagios-plugins-2.x.tar.gz
tar zxvf nagios-plugins-2*.tar.gz
cd nagios-plugins-*/
./configure --with-nagios-user=nagios --with-nagios-group=nagios
make
sudo make install
```

### 5) Configurer compte web (Nagios UI)

```bash
sudo htpasswd -c /usr/local/nagios/etc/htpasswd.users nagiosadmin
# définir un mot de passe
```

### 6) Démarrer Nagios et Apache

```bash
sudo systemctl enable apache2
sudo systemctl restart apache2
sudo systemctl enable nagios
sudo systemctl start nagios
```

Accède à `http://<IP>/nagios` et connecte-toi avec `nagiosadmin`.

### 7) Installer NRPE / plugins sur clients (ex. serveur Linux à monitorer)

Sur la machine cliente (ou même sur le serveur Nagios pour tests) :

```bash
# sur Debian/Ubuntu
sudo apt -y install nagios-nrpe-server nagios-plugins

# configurer /etc/nagios/nrpe.cfg : allowed_hosts=<IP_NAGIOS_SERVER>
sudo systemctl enable --now nagios-nrpe-server
```

Côté serveur Nagios, ajouter `check_nrpe` command & host/service definitions.

### 8) Vérifications

* Vérifier config Nagios :

```bash
/usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg
```

* Logs : `/usr/local/nagios/var/nagios.log` et `/var/log/apache2/error.log`.
* Tester un check NRPE :

```bash
/usr/lib/nagios/plugins/check_nrpe -H <client_ip> -c check_load
```

---

## C — Options de sécurité & hardening (valables pour Centreon & Nagios)

* Activer **HTTPS** pour l’UI (Let's Encrypt / certificat interne).
* Restreindre l’accès web (ACLs, VPN, IP allowlist).
* Limiter les IP autorisées à interroger NRPE / SNMP dans leurs fichiers de config.
* Préférer **SNMPv3** pour les équipements réseau (auth/priv).
* Ne pas laisser mots de passe en clair dans les fichiers ; utiliser vault si possible.
* Mettre en place sauvegardes automatiques de la BDD et des configs (cron pour `mysqldump` + tar).
* Mettre à jour régulièrement engine & plugins.

---

## D — Vérification & tests de fonctionnement

1. **Ajouter un hôte** (ex : serveur1) et un service `PING` / `HTTP` depuis l’UI (Centreon) ou fichiers cfg (Nagios).
2. **Forcer un état** (arrêter service) et vérifier que l’alerte remonte et la notification part.
3. **Tester plugins** en local (ex : `check_http`, `check_ping`, `check_nrpe`).
4. **Vérifier logs** en cas d’erreur (engine, broker, apache, mysql).

---

## E — Rappels commandes utiles (synthèse)

```bash
# CentOS
systemctl start|stop|status httpd mariadb centengine centreon-broker

# Ubuntu/Nagios
systemctl start|stop|status nagios apache2

# Vérifier config Nagios
/usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg

# SNMP test
snmpwalk -v2c -c public <host> .1.3.6.1.2.1

# NRPE test
/usr/lib/nagios/plugins/check_nrpe -H <host> -c <cmd>
```

---

## F — Checklist rapide de déploiement (mini projet)

* [ ] Préparer VM (CentOS 7 pour Centreon ou Ubuntu pour Nagios).
* [ ] Config réseau & hostname, vérifier ping depuis poste admin.
* [ ] Installer dépendances (Apache, PHP, MySQL/MariaDB, plugins).
* [ ] Installer Centreon (image/GUI) ou Nagios (source/paquets).
* [ ] Créer comptes admin web, sécuriser MySQL (`mysql_secure_installation`).
* [ ] Ouvrir ports firewall (HTTP/HTTPS, SNMP, NRPE).
* [ ] Ajouter 3 hôtes tests (Linux/Windows/switch via SNMP) + checks basiques (ping, disk, cpu).
* [ ] Configurer notifications & un contact. Tester.
* [ ] Mettre en place sauvegarde et HTTPS.

---
