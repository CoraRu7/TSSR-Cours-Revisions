# Fiche — **Administrer le superviseur Centreon**

(Partie : installation des services, Plugin Packs, création d’hôtes/services SNMP, export Pollers)

---

## Contexte / objectif

Savoir paramétrer un serveur Centreon pour superviser des hôtes et services (ex. via SNMP) : préparer la machine, lancer les services Centreon (engine, broker, gorgoned, snmpd/Trapd...), installer les Plugin Packs, créer des hôtes et services, appliquer la configuration via les *pollers*.

---

## Pré-requis

* VM/serveur CentOS 7 avec Centreon installé et accessible via IP (ex. `192.168.1.239`).
* Compte `root` sur la VM (mot de passe défini).
* Accès web à l’interface Centreon (port 80/443).
* Hôte à superviser (ex. machine Windows) joignable depuis le serveur Centreon.
* Connaître la communauté SNMP utilisée (ici exemple `studi`) ou préférer SNMPv3.

---

## Commandes système essentielles (à exécuter sur le serveur Centreon)

> Copier-coller ces commandes en root sur le serveur Centreon.

Configurer le nom d’hôte :

```bash
hostnamectl set-hostname <nom-du-serveur>
# ex.
hostnamectl set-hostname centreon-studi
```

Mettre à jour et redémarrer :

```bash
yum update
reboot
```

Activer les services au démarrage (commande telle que vue en démo) :

```bash
systemctl enable rh-php73-php-fpm httpd24-httpd mariadb centreon cbd centengine gorgoned snmptrapd centreontrapd snmpd
```

Démarrer / redémarrer et vérifier l’état des services (ordre / exemples) :

```bash
# cbd et centengine
systemctl restart cbd centengine
systemctl status cbd centengine

# gorgoned
systemctl restart gorgoned
systemctl status gorgoned

# snmptrapd et centreontrapd
systemctl start snmptrapd centreontrapd
systemctl status snmptrapd centreontrapd

# snmpd
systemctl start snmpd
systemctl status snmpd
```

> Observé en démo : les `status` doivent indiquer `active (running)`.

---

## 1) Installer / activer les Plugin Packs (via l’UI Centreon)

**But :** disposer de modèles prêts à l’emploi (Windows, Cisco, printer, UPS, etc.)

Étapes (UI) — résumé :

1. Se connecter à l’interface Centreon (`http://<IP>`).
2. Menu **Paramètres → Plugin Packs**.
3. Rechercher les packs voulus (ex. *Centreon Central*, *Centreon Database*, *Poller*, *Cisco Standard*, *Printer Standard*, *UPS Standard*, *Windows SNMP*).
4. Si la case n’est pas cochée, cliquer sur **+** pour installer le pack.
5. Après installation, vérifier dans **Pollers → Configure pollers** que les pollers (Central) sont visibles.

---

## 2) Créer un hôte (ex. Windows via SNMP) — procédure UI

1. **Paramètres → Hosts → Hosts → Add**.
2. Remplir :

   * **Name** : `windows10` (ex.)
   * **Alias** : `win10`
   * **Address** : adresse IP du poste (ex. `192.168.1.50`)
   * **SNMP community** : `studi` (ex.)
   * **SNMP version** : `2c` (ou `3` si configuré)
   * **Templates** : `generic-active-host-custom` (ou le template recommandé)
3. **Save**.

> Astuce : utilise un nom explicite et conserve la communauté dans un endroit sécurisé.

---

## 3) Créer des services liés à l’hôte (CPU, Mémoire, …) — procédure UI

1. **Paramètres → Services → Services by host → Add**.
2. Remplir :

   * **Description** : `CPU`
   * **Linked with host** : sélectionner `windows10`
   * **Template** : `OS-Windows-Cpu-SNMP` (ex. ; peut varier selon Plugin Pack)
3. **Save**.
4. Répéter pour `Mémoire` avec template `OS-Windows-Memory-SNMP`, etc.

---

## 4) Configurer la sécurité SNMP côté Centreon (autoriser communauté / hosts)

1. Dans l’UI, accéder au service SNMP (ou aux options globales SNMP).
2. Onglet **Sécurité** : ajouter la **SNMP community** (`studi`).

   * Droits : lecture seule recommandé pour la production ; lecture/écriture si nécessaire.
3. Autoriser les paquets SNMP provenant du host Centreon (ex. ajouter IP `192.168.1.239`).
4. **Appliquer / OK**.

> Remarque : côté équipement Windows, il faudra configurer la même communauté et autoriser l’IP du serveur Centreon.

---

## 5) Activer SNMP côté Windows (configuration rapide)

1. **Panneau de configuration → Programmes → Fonctionnalités facultatives → Ajouter une fonctionnalité** → installer **SNMP** si absent.
2. **Services** → localiser **SNMP Service** → Propriétés → onglet **Security** :

   * **Accepted community names** → ajouter `studi` (droits Lecture / Écriture selon besoin).
   * **Accept SNMP packets from these hosts** → ajouter l’IP du serveur Centreon (ex. `192.168.1.239`).
3. Redémarrer le service SNMP si nécessaire.

---

## 6) Appliquer la config globale → Export Pollers (traduction des configs vers engine)

> Important : sans export, les modifications restent en base et ne sont pas prises par les pollers.

Étapes UI :

1. **Pollers** (icône en haut à gauche) → **Configure pollers**.
2. Coche **Central** (le poller cible).
3. Options : cocher **Move export files** et **Restart monitoring engine** (ou *Restart* selon besoin).

   * Si tu veux pouvoir supprimer des objets, utilise **Restart** au lieu de **Reload** (démo : attention à choisir la bonne option).
4. Cliquer **Export**.
5. Une console s’affiche indiquant le résultat ; attendre la fin.

Résultat attendu : l’hôte passe `UP` et les services commencent à remonter leur état.

---

## 7) Vérification et supervision

* Dans l’UI : **Hosts** → vérifier `windows10` → état `UP`.
* **Services** → vérifier `CPU`, `Memory` → état (OK / WARNING / CRITICAL).
* Pour graphiques : cliquer sur le service (`CPU`) → onglet Graphs / Performance.

---

## 8) Bonnes pratiques & sécurité

* **Préférer SNMPv3** (auth & chiffrement) en production → configure côté équipement et template Centreon.
* Limiter l’accès SNMP au serveur Centreon (liste d’hôtes autorisés).
* Ne pas utiliser `public` comme communauté.
* Activer HTTPS pour l’UI Centreon (certificat validé).
* Sauvegarder régulièrement la DB Centreon (`mysqldump`) et la config Centeron.
* Mettre en place rotation des logs et supervision du superviseur lui-même.

---

## 9) Dépannage courant

* **Service Centreon ne démarre pas** : vérifier journaux `/var/log/centreon/` ou `journalctl -u centengine` / `systemctl status <service>`.
* **Poller ne prend pas la config** :

  * Vérifier export (console d’export).
  * Sur le poller, vérifier présence des fichiers exportés (dossier d’export).
  * Relancer `centengine` / `cbd` / `centreon-broker`.
* **SNMP timeout** : vérifier que `snmpd` tourne sur la machine cible, que la communauté est identique, que firewall autorise UDP/161 et que Centreon IP est autorisée.
* **Template manquant** : vérifier que le Plugin Pack est bien installé et à jour dans **Plugin Packs**.

Commandes utiles de diagnostic (serveur Centreon) :

```bash
# vérifier services
systemctl status cbd centengine gorgoned snmptrapd centreontrapd snmpd

# logs (exemples)
tail -f /var/log/centreon/centengine.log
journalctl -u cbd -f
```

---

## 10) Checklist rapide (déploiement / mise en production)

* [ ] hostname correct (`hostnamectl set-hostname ...`)
* [ ] système mis à jour (`yum update`) + reboot si nécessaire
* [ ] services Centreon activés (`systemctl enable ...`)
* [ ] services démarrés et `active (running)` (cbd, centengine, gorgoned, snmpd, snmptrapd, centreontrapd)
* [ ] Plugin Packs installés (UI)
* [ ] Hôte ajouté avec bonne IP & SNMP community
* [ ] Services liés à l’hôte créés (CPU, Memory, Disk...) via templates Plugin Pack
* [ ] SNMP configuré côté client (community + autorisation Centreon IP)
* [ ] Export config Pollers → **Export** + restart monitoring engine
* [ ] Vérifier remontée d’état & graphiques

---