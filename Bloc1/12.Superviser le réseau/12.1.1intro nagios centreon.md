# Fiche — Introduction à la supervision (Nagios / Centreon)

Fiche synthétique et actionnable pour comprendre les concepts, composants et **mettre en place** une supervision de base avec Nagios / Centreon. Contient définitions, architecture, protocoles/agents, exemples de configurations, commandes utiles, bonnes pratiques sécurité et dépannage.

---

## 1) Objectif de la supervision

* **Surveiller** l’état des services, hôtes, équipements réseau et performances (CPU, RAM, disque, latence…).
* **Alerter** (mail, SMS, webhook) en cas d’anomalie pour permettre une intervention rapide.
* **Visualiser** l’historique et les tendances (graphiques) pour le capacity planning.
* **Automatiser** des actions correctrices (scripts, redémarrage de services).

---

## 2) Nagios vs Centreon — notion rapide

* **Nagios Core** : moteur de supervision historique, plugin-based. Architecture : Scheduler (engine), plugins, interface web (CGI) + fichiers de config. Très flexible mais configuration texte manuelle.
* **Centreon** : plateforme basée historiquement sur Nagios mais modernisée (Centreon Engine, Broker, Web). Fournit interface web riche, modèles, dashboards, EPP (plugin packs), API, intégrations. Centreon simplifie la gestion à grande échelle et l’industrialisation.

---

## 3) Architecture générale d’une supervision

* **Engine / Scheduler** : exécute les checks (Nagios/Centreon Engine).
* **Plugins / Checks** : petits programmes externes (check_ping, check_http, check_snmp, check_nrpe…).
* **Broker / Bus d’événements** : centralise les résultats, distribue aux bases/GUI (Centreon Broker).
* **Base de données** : stocke configuration, historiques, performances (Centreon utilise une BDD pour la web UI).
* **Interface web / Dashboard** : consultation, gestion, notifications.
* **Agents / Protocoles de collecte** : SNMP, NRPE, SSH/check_by_ssh, WMI, API REST, agents propriétaires.
* **Système d’alerting** : notifications, escalades, fenêtres de maintenance.

---

## 4) Protocoles & agents courants

* **SNMP** (agent passif sur équipement réseau/serveur) → lecture OIDs (`snmpwalk`, `snmpget`).
* **NRPE / check_nrpe** (Nagios Remote Plugin Executor) → exécution distante de plugins sur Linux.
* **check_by_ssh** → exécuté via SSH, utile si NRPE non disponible.
* **WMI / check_wmi** → pour serveurs Windows.
* **Agents natifs (Centreon/NRPE/NRDP)** et **API** pour remontées passives.

Ports réseau clés (à vérifier sur firewall) :

* SNMP : UDP **161** (agent), 162 trap.
* NRPE : TCP **5666** (par défaut).
* SSH : TCP **22**.
* Web UI : HTTP **80** / HTTPS **443**.

---

## 5) Principales tâches à réaliser (workflow de mise en œuvre)

1. **Installer** engine (Nagios ou Centreon) et dépendances (Perl/PHP, Apache/Nginx, MySQL/MariaDB pour Centreon).
2. **Installer plugins Nagios** (package nagios-plugins ou compilation).
3. **Configurer les hôtes** (hosts) → ip, host_name, groups.
4. **Définir services** → commandes de check, intervalle, seuils OK/WARNING/CRITICAL.
5. **Configurer contacts / notifications** (email, escalades, périodes).
6. **Ajouter agents** (SNMP/NRPE/WMI) sur les cibles.
7. **Tester** les checks individuellement puis via interface.
8. **Plannifier maintenance** (fenêtres où pas d’alertes).
9. **Sauvegarder la configuration** et automatiser (git, backup DB).

---

## 6) Exemples concrets (Nagios) — fichiers & snippets

> **Emplacement typique** (dépend de l’installation) :
> `/etc/nagios/` ou `/usr/local/nagios/etc/`

### a) Définir une commande (commands.cfg)

```cfg
define command{
  command_name    check_ping
  command_line    /usr/lib/nagios/plugins/check_ping -H $HOSTADDRESS$ -w 100.0,20% -c 200.0,40% -p 5
}
```

### b) Définir un host (hosts.cfg)

```cfg
define host{
  use             generic-host
  host_name       web01
  alias           Serveur Web 01
  address         192.168.10.10
  max_check_attempts 3
}
```

### c) Définir un service (services.cfg)

```cfg
define service{
  use                     generic-service
  host_name               web01
  service_description     HTTP
  check_command           check_http!-I 192.168.10.10 -u /health
  check_interval          5
  retry_interval          1
}
```

### d) Contact & notification (contacts.cfg)

```cfg
define contact{
  contact_name    ops
  alias           On-call
  email           ops@example.com
}
```

### e) Vérifier la config Nagios

```bash
# si Nagios installé sous /usr/local/nagios
/usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg

# ou si package : 
nagios -v /etc/nagios/nagios.cfg
```

### f) Redémarrer le service

```bash
systemctl restart nagios
systemctl status nagios
journalctl -u nagios -f
```

---

## 7) Exemples pratiques d’agents/checks

### NRPE (sur le client Linux)

* Installer `nrpe` et `nagios-plugins` sur la machine à superviser.
* `/etc/nagios/nrpe.cfg` : ajouter les commandes locales :

```cfg
command[check_disk]=/usr/lib/nagios/plugins/check_disk -w 20% -c 10% -p /
command[check_load]=/usr/lib/nagios/plugins/check_load -w 5,4,3 -c 10,6,4
```

* Côté serveur Nagios, definir la commande `check_nrpe` :

```cfg
define command{
  command_name check_nrpe
  command_line /usr/lib/nagios/plugins/check_nrpe -H $HOSTADDRESS$ -c $ARG1$
}
```

* Service exemple :

```cfg
define service{
  host_name web01
  service_description Disk / 
  check_command check_nrpe!check_disk
}
```

### SNMP (switch|routeur)

```bash
# depuis un serveur de supervision
snmpwalk -v2c -c public 192.168.0.1 .1.3.6.1.2.1.25.3.3  # OID CPU, etc.
```

* Utiliser `check_snmp` plugin pour créer checks SNMP.

---

## 8) Centreon — notions pratiques

* Centreon propose une **UI web** pour : inventaire d’hôtes, templates, services, notifications, dashboards, graphiques perf (RRDtool ou BI).
* Architecture moderne : **Centreon Engine** (exécution checks), **Centreon Broker** (transports), **Centreon Web** (UI + API), **BDD**.
* **Plugin Packs (EPP)** permettent de déployer rapidement modèles de supervision par métier.
* Actions usuelles dans Centreon : importer hôtes via CSV, créer modèles (host-template / service-template), configurer collecteurs distants (Pollers) pour grandes infrastructures.

> Remarque : la plupart des opérations se font depuis l’interface web Centreon (GUI). Centreon propose aussi une API CLI pour automatiser.

---

## 9) Notifications, escalade et fenêtres de maintenance

* **Contacts** : personnes / groupes à notifier.
* **Contacts Groups** : regrouper destinataires (ops, admin, service X).
* **Notification Commands** : scripts d’envoi (mail, SMS via gateway, webhook).
* **Escalation** : définir règles d’escalade si pas d’acquittement (ex : après 3 tentatives, notifier manager).
* **Maintenance Windows** / Downtime : planifier pour éviter alertes temporaires (sauvegardes, changements).

---

## 10) Bonnes pratiques de sécurité

* Restreindre accès à l’interface web (HTTPS TLS, IP allowlist).
* Utiliser **SSH key-based** pour check_by_ssh et interdire mots de passe.
* Protéger SNMP : ne pas utiliser `public` en prod ; préférer SNMPv3 (auth+priv).
* Limiter accès NRPE (liste d’IP autorisées dans `nrpe.cfg`).
* Chiffrer communications entre pollers et central (Centreon Broker supporte TLS).
* Mettre à jour plugins & engine, appliquer correctifs sécurité.
* Stocker mots de passe/credentials dans coffre-fort (Vault) et ne pas les laisser en clair dans configs publiques.

---

## 11) Supervision à l’échelle (scalability)

* **Pollers distribués** (collecteurs) : répartir la charge des checks.
* **Broker / Bus** pour centraliser résultats et distribuer vers DB / GUI.
* **High-availability** : redondance du moteur + DB + UI. Centreon supporte architectures distribuées.

---

## 12) Sauvegardes & reprise

* Sauvegarder : fichiers de config (`/etc/nagios/`, `/etc/centreon/`), base de données Centreon (MySQL/MariaDB) et répertoires RRD/graphs.
* Script type :

```bash
mysqldump -u centreon -p centreon > /backup/centreon_db.sql
tar czf /backup/centreon_etc_$(date +%F).tgz /etc/centreon /usr/local/centreon /var/lib/centreon
```

---

## 13) Commandes & outils utiles (rappel)

* `nagios -v /path/to/nagios.cfg` → vérifier config Nagios.
* `systemctl status nagios|centreon*|nrpe` → statut services.
* `journalctl -u nagios -f` → logs en temps réel.
* `snmpwalk -v2c -c <community> <host> <OID>` → test SNMP.
* `./check_nrpe -H <host> -c <command>` → tester NRPE.
* `tail -f /var/log/centreon/centengine.log` (ou path Centreon) → logs engine.
* `tcpdump` / `ss` / `netstat` → debug réseau.

---

## 14) Dépannage courant

* **Aucune donnée/alertes** : vérifier que poller/engine tourne (`systemctl status`), vérifier `broker` et communication DB.
* **Check échoue localement** : exécuter le plugin manuellement (ex : `/usr/lib/nagios/plugins/check_disk -w 20% -c 10% /`).
* **Config non prise en compte** : vérifier `nagios -v` / re-générer config Centreon & re-deployer (Centreon -> Configuration -> Poller -> Export).
* **Trop d’alertes (flood)** : mettre en place dépendances entre services/hosts et utiliser maintenance windows.
* **Port fermé** : vérifier firewall (iptables/nftables/ufw, firewall appliance).

---

## 15) Exemple de checklist de déploiement minimal

1. Installer OS serveur (ex. CentOS/Ubuntu), sécurité de base.
2. Installer Nagios Core ou Centreon (suivre la doc officielle pour versions).
3. Installer nagios-plugins & check_by_ssh / NRPE.
4. Créer 5 hôtes pilote (serveur web, base, switch, routeur, DB).
5. Configurer checks CPU, disk, service HTTP, ping.
6. Mettre en place 1 contact + notification mail. Tester en simulant un état CRITICAL.
7. Ajouter SNMP sur un switch et vérifier `snmpwalk`.
8. Documenter et sauvegarder la config.

---

## 16) Références & suites d’apprentissage (suggestions)

* Lire documentation officielle Nagios Core (concepts, plugins).
* Lire documentation Centreon (architecture, pollers, EPP).
* S’exercer sur Packet/VM : surveiller serveurs virtuels, configurer NRPE & SNMP, créer dashboards.

---
