> ⚠️ **Avertissement sécurité / production**
>
> * Ne déploie jamais un cluster en production sans fencing (STONITH) : j’explique la logique et les options plus bas.
> * Teste d’abord dans un labo (VM), puis ajoute DRBD/replication et STONITH pour la production.

---

# FICHE TECHNIQUE — Heartbeat (HA) sur Debian : procédure complète

---

## 0) Hypothèses et variables (à adapter)

* Nœud A : `hb1` — IP physique `192.168.0.45` — interface `ens160`
* Nœud B : `hb2` — IP physique `192.168.0.29` — interface `ens160`
* VIP (adresse virtuelle) : `192.168.0.200/24`
* Interface virtuelle : `ens160:0`
* Service surveillé : `apache2`
* Secret d’authentification Heartbeat : `MaClefUltraSecurisee` (remplace par un mot de passe fort)

---
<details>
<summary>

## 1) Préparation de base (sur les 2 nœuds)
</summary>

### 1.1 Mettre à jour le système


```bash
sudo apt update && sudo apt upgrade -y
```

**Pourquoi ?** : corrige bugs, vulnérabilités et garantit que les packages requis s’installent proprement.

---


### 1.2 Définir hostname et /etc/hosts (sur chaque nœud)


Sur hb1 :

```bash
sudo hostnamectl set-hostname hb1
sudo sed -i '/hb1/d' /etc/hosts
echo "192.168.0.45 hb1" | sudo tee -a /etc/hosts
echo "192.168.0.29 hb2" | sudo tee -a /etc/hosts
```

Sur hb2 (inverser IP/nom) :

```bash
sudo hostnamectl set-hostname hb2
sudo sed -i '/hb2/d' /etc/hosts
echo "192.168.0.45 hb1" | sudo tee -a /etc/hosts
echo "192.168.0.29 hb2" | sudo tee -a /etc/hosts
```

**Pourquoi ?** : Heartbeat référence les nœuds par hostname — `/etc/hosts` assure résolution sans DNS.

---

### 1.3 Configurer IP statique si nécessaire


**Option A — temporaire (test rapide)**

```bash
sudo ip addr add 192.168.0.45/24 dev ens160    # sur hb1
sudo ip route add default via 192.168.0.1
```

**Option B — permanente (si Debian utilise /etc/network/interfaces)**
Éditer `/etc/network/interfaces` (exemple) :

```bash
sudo nano /etc/network/interfaces
```

Ajouter / modifier :

```
auto ens160
iface ens160 inet static
  address 192.168.0.45
  netmask 255.255.255.0
  gateway 192.168.0.1
  dns-nameservers 8.8.8.8 1.1.1.1
```

Puis :

```bash
sudo systemctl restart networking
```

**Pourquoi ?** : Heartbeat nécessite IP fixes et connectivité stable.

---

### 1.4 Synchro d’horloge (recommandé)

Sur les deux nœuds :

```bash
sudo apt install chrony -y
sudo systemctl enable --now chrony
chronyc tracking
```

**Pourquoi ?** : éviter dérives d’horloge pouvant déstabiliser mécanismes de timeout.

---

### 1.5 Installer les packages nécessaires (sur les 2 nœuds)

```bash
sudo apt install heartbeat apache2 -y
```

**Pourquoi apache2 ?** : service de test redondé ; remplace par ton service réel si besoin.

---
</details>
<details>
<summary>

## 2) Fichiers essentiels de Heartbeat — création et contenu
</summary>

> Tous ces fichiers doivent **exister et être cohérents** sur **chaque nœud**.


### 2.1 Créer les fichiers s’ils n’existent pas


```bash
sudo mkdir -p /etc/heartbeat
cd /etc/heartbeat
sudo touch ha.cf authkeys haresources
```

---

### 2.2 Configurer `/etc/heartbeat/ha.cf`


Édite le fichier (`sudo nano /etc/heartbeat/ha.cf`) et colle (ajuste `ucast` sur chaque nœud) :

**Sur hb1 (`ucast` cible = IP de hb2) :**

```
logfile /var/log/heartbeat.log
logfacility daemon
node hb1 hb2
keepalive 1
deadtime 10
initdead 15
warntime 5
ucast ens160 192.168.0.29
auto_failback yes
```

**Sur hb2 (`ucast` cible = IP de hb1) :**

```
logfile /var/log/heartbeat.log
logfacility daemon
node hb1 hb2
keepalive 1
deadtime 10
initdead 15
warntime 5
ucast ens160 192.168.0.45
auto_failback yes
```

**Explications :**

* `keepalive 1` : Heartbeat envoie un battement toutes les 1s.
* `deadtime 10` : si pas de réponse en 10s, considère le pair mort (ajuster selon réseau).
* `ucast INTERFACE IP` : envoi unicast du heartbeat vers IP pair (plus fiable que broadcast sur réseaux complexes).
* `auto_failback yes` : si le maître revient en ligne, il récupère automatiquement les ressources (pas toujours souhaitable en prod).

---

### 2.3 Configurer `/etc/heartbeat/authkeys`

```bash
sudo nano /etc/heartbeat/authkeys
```

Contenu (même sur les deux nœuds) :

```
auth 1
1 sha1 MaClefUltraSecurisee
```

Puis protéger le fichier :

```bash
sudo chmod 600 /etc/heartbeat/authkeys
sudo chown root:root /etc/heartbeat/authkeys
```

**Pourquoi ?** : clé partagée pour authentifier les messages Heartbeat (évite commandes spoofées).

---

### 2.4 Configurer `/etc/heartbeat/haresources`

```bash
sudo nano /etc/heartbeat/haresources
```

Contenu (sur **tous** les nœuds — indique le maître initial) :

```
hb1 IPaddr::192.168.0.200/24/ens160:0 apache2
```

**Explications** :

* `hb1` : nœud indiqué comme propriétaire initial.
* `IPaddr::192.168.0.200/24/ens160:0` : crée l’interface virtuelle `ens160:0` et lui assigne la VIP.
* `apache2` : service que Heartbeat démarrera/stoppra automatiquement. Si tu veux redonder **tous** les services, ne mets pas le service et Heartbeat prendra tout (mais mieux vaut aiguiller précisément).

---
</details>
<details>
<summary>

## 3) Permissions, démarrage et vérifications
</summary>

### 3.1 Fixer permissions (déjà fait pour authkeys)


```bash
sudo chmod 600 /etc/heartbeat/authkeys
```
### 3.2 Redémarrer le service Heartbeat (sur les deux nœuds)

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now heartbeat
sudo systemctl restart heartbeat
sudo systemctl status heartbeat --no-pager
```

### 3.3 Vérifier que la VIP est présente sur le nœud maître

Sur le maître (hb1 si tu as mis hb1 en haresources) :

```bash
ip a show ens160
# ou vérifier la VIP précisément
ip -4 addr show | grep 192.168.0.200 -B1
```

Tu dois voir `ens160:0` ou la ligne `inet 192.168.0.200/24`.

### 3.4 Test de service local

Sur n’importe quel poste du réseau :

```bash
curl -sS http://192.168.0.200 | head -n 1
```

La page doit répondre (HTML du `index.html` de hb1).

---
</details>
<details>
<summary>

## 4) Tests de bascule — procédures et commandes
</summary>

> Toujours faire ces tests dans un environnement contrôlé.

### 4.1 Test A — arrêt du service Apache sur le nœud maître

Sur hb1 (maître) :

```bash
sudo systemctl stop apache2
```

Attends 5–15s — Heartbeat doit détecter et démarrer Apache sur hb2 et VIP doit basculer.
Vérification (sur nœud client) :

```bash
curl -sS http://192.168.0.200
```

### 4.2 Test B — simuler coupure réseau du maître

Sur hb1 :

```bash
sudo ip link set ens160 down
# ou
sudo ifdown ens160
```

Vérifier sur hb2 :

```bash
ip a | grep 192.168.0.200 -B1
sudo systemctl status apache2
```

Résultat attendu : VIP et Apache actifs sur hb2.

### 4.3 Test C — rétablir le maître et contrôler failback

Remet la carte réseau :

```bash
sudo ip link set ens160 up
# ou
sudo ifup ens160
```

Si `auto_failback yes`, après délai `deadtime` et négociations, VIP retournera à hb1. Sinon, si `no`, rester sur hb2 jusqu’à intervention.

---
</details>
<details>
<summary>

## 5) Commandes de diagnostic et logs
</summary>

* Voir logs Heartbeat :

```bash
sudo tail -f /var/log/heartbeat.log
sudo journalctl -u heartbeat -f
```

* Vérifier statut :

```bash
sudo systemctl status heartbeat
```

* Vérifier quelles ressources sont gérées (haresources) :

```bash
cat /etc/heartbeat/haresources
```

* Vérifier ip addresses :

```bash
ip a
```

* Tester connectivité entre nœuds :

```bash
ping -c 4 192.168.0.29   # depuis hb1
nc -zv 192.168.0.29 22  # vérif port ssh
```

---
</details>
<details>
<summary>

## 6) Cas pratiques avancés (production — impliquer ces étapes)
</summary>

### 6.1 DRBD — réplication de volumes block-level (optionnel mais recommandé)

* **But** : données synchronisées en temps réel entre nœuds (utile pour bases de données / sites).
* **Commandes d’installation de base** :

```bash
sudo apt install drbd-utils drbd-dkms -y
```

* DRBD nécessite config fine (`/etc/drbd.d/*.res`) et synchronisation initiale; **ne pas** l’activer sans tests.

### 6.2 STONITH / Fencing (obligatoire en prod)

* **But** : éviter split-brain en "éteignant" un nœud défaillant via IPMI, external power switch, or fence_ssh.
* Exemples :

  * `fence_ipmilan`, `fence_virsh`, `fence_ilo`, `fence_ssh` — installer `fence-agents`.

```bash
sudo apt install fence-agents -y
```

* **Procédure** : configurer un agent fencing adapté (ex : IPMI) et intégrer sa commande dans les scripts de cluster — sans fencing, le cluster n’est pas sûr en production.

---
</details>
<details>
<summary>

## 7) Bonnes pratiques & recommandations
</summary>

* **Toujours** configurer STONITH en environnement critique.
* **Synchroniser** les OS et versions de packages entre nœuds.
* **Backups** réguliers (configuration + données) et plan de restauration documenté.
* **Monitoring externe** (Nagios, Zabbix) pour surveiller le cluster et alerter.
* Ajuster `keepalive` / `deadtime` selon la latence et stabilité du réseau (réseau instable → augmenter `deadtime` pour éviter bascules intempestives).
* Mettre `authkeys` en `chmod 600`.
* Documenter **qui** possède la VIP (haresources) et les services redondés.

---
</details>
<details>
<summary>

## 8) Résolution des problèmes fréquents
</summary>

|                  Symptom | Vérification                   | Solution                                                                         |
| -----------------------: | ------------------------------ | -------------------------------------------------------------------------------- |
| Heartbeat ne démarre pas | `sudo journalctl -u heartbeat` | Vérifier permissions `authkeys` (`chmod 600`), format du fichier                 |
|          VIP non visible | `ip a`                         | Vérifier `haresources` syntaxe, interface correcte (`ens160`), restart heartbeat |
|           Pas de bascule | `tail /var/log/heartbeat.log`  | Vérifier `ucast` IP, firewall bloquant UDP entre nœuds, connectivity             |
|              Split-brain | services actifs sur 2 nœuds    | Ajouter STONITH, vérifier clock sync, réseau de management séparé                |

---
</details>
<details>
<summary>

## 9) Checklist de déploiement (récapitulatif)
</summary>

1. Config IP fixes, hostnames, `/etc/hosts` configuré.
2. Chrony installé et synchronisé.
3. Packages installés `heartbeat`, `apache2` (ou ton service).
4. Fichiers `/etc/heartbeat/ha.cf`, `/etc/heartbeat/authkeys`, `/etc/heartbeat/haresources` créés et identiques (sauf `ucast`) sur chaque nœud.
5. `chmod 600 /etc/heartbeat/authkeys`.
6. `systemctl enable --now heartbeat` sur les deux nœuds.
7. Vérifier la VIP, ping, HTTP depuis client.
8. Tester coupure du maître (ifdown / stop service) → vérifier failover.
9. Configurer STONITH + DRBD si besoin pour production.

---
</details>
<details>
<summary>

## 10) Scripts utiles (exemples)
</summary>

### 10.1 Script pour forcer failover (test)

Sur hb1 (exécuté localement) :

```bash
sudo systemctl stop apache2
sleep 5
sudo ip link set ens160 down
```

Attendre et vérifier que hb2 récupère la VIP.

### 10.2 Script pour remettre en ligne

Sur hb1 :

```bash
sudo ip link set ens160 up
sudo systemctl start apache2
```

---
</details>
<details>
<summary>

## 11) Conclusions courtes (à retenir)
</summary>

* **Heartbeat** fournit **monitoring simple et failover** via VIPs et scripts.
* **Configuration** = 3 fichiers (`ha.cf`, `authkeys`, `haresources`) + IP fixes + services identiques.
* **Test** impératif : coupures, redémarrage, restauration, monitoring.
* **Production** : ajouter **fencing (STONITH)** et **réplication** (DRBD, shared storage) avant mise en service.

---
</details>