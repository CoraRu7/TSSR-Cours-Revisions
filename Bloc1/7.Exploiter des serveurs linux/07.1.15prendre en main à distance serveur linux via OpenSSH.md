# üßæ Fiche ‚Äî Prise en main √† distance des serveurs Linux via OpenSSH

---
<details>
<summary>

## üéØ Objectif
</summary>

Savoir installer, configurer, s√©curiser et utiliser OpenSSH pour administrer des serveurs Linux √† distance (connexion interactive, authentification par cl√©s, transfert de fichiers via `scp`/`sftp`), automatiser et durcir l‚Äôacc√®s (fail2ban, restriction IP, d√©sactivation root), et diagnostiquer les probl√®mes courants.

---
</details>
<details>
<summary>

## üß† Concepts cl√©s (rapide)
</summary>

* **SSH** : protocole s√©curis√© pour acc√®s distant (chiffrement, int√©grit√©, authentification).
* **OpenSSH** : impl√©mentation libre (client + serveur + outils : `ssh`, `sshd`, `scp`, `sftp`, `ssh-keygen`, `ssh-agent`, `ssh-copy-id`).
* **Auth par cl√©** : paire `priv√©e/publique` ‚Äî la cl√© publique va dans `~/.ssh/authorized_keys` du serveur.
* **Tunnel SSH / forwarding** : redirection de ports locaux/distants via SSH.
* **sshd_config** : fichier de config serveur `/etc/ssh/sshd_config`.
* **S√©curit√©** : d√©sactiver `PermitRootLogin`, `PasswordAuthentication=no`, prot√©ger permissions cl√©s (`chmod 600`), fail2ban, firewall.

---
</details>
<details>
<summary>

## 1 ‚Äî Installation & d√©marrage (serveur)
</summary>

### √âtapes rapides (Debian/Ubuntu)

```bash
sudo apt update
sudo apt install openssh-server -y
sudo systemctl enable --now ssh
sudo systemctl status ssh
```

### V√©rifications utiles

```bash
ss -tlnp | grep sshd      # port d'√©coute (22 par d√©faut)
sudo journalctl -u ssh -e # logs boot/service
ls -l /etc/ssh/sshd_config
```

---
</details>
<details>
<summary>

## 2 ‚Äî Configuration initiale (fichier `/etc/ssh/sshd_config`)
</summary>

### Extraits conseill√©s (s√©curis√©)

Ouvre et √©dite :

```bash
sudo nano /etc/ssh/sshd_config
```

Ajouter / modifier :

```ini
Port 22                     # ou un port non-standard (ex : 2222)
ListenAddress 0.0.0.0       # ou IP sp√©cifique du serveur
PermitRootLogin no
PasswordAuthentication yes  # temporaire pour config cl√©s; mettre no ensuite
PubkeyAuthentication yes
AllowUsers ton_user         # optionnel : restreindre utilisateurs
ClientAliveInterval 300
ClientAliveCountMax 2
```

Apr√®s modif :

```bash
sudo systemctl restart ssh
sudo systemctl status ssh
sudo ss -tlnp | grep sshd
```

> Conseil : si tu changes le port, ouvre-le dans le firewall **avant** de fermer ta session (ufw/iptables).

---
</details>
<details>
<summary>

## 3 ‚Äî Authentification par cl√© (m√©thode recommand√©e)
</summary>

### G√©n√©rer la paire de cl√©s (client)

```bash
ssh-keygen -t rsa -b 4096 -C "ton_email@exemple.com"
# accepte le chemin par d√©faut (~/.ssh/id_rsa) ; optionnel : passphrase
```

### Copier la cl√© publique sur le serveur

M√©thode simple :

```bash
ssh-copy-id user@IP_du_serveur
```

Manuelle (si ssh-copy-id indisponible) :

```bash
cat ~/.ssh/id_rsa.pub | ssh user@IP 'mkdir -p ~/.ssh && chmod 700 ~/.ssh && cat >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys'
```

### V√©rifier / permissions

Sur le serveur :

```bash
ls -ld ~/.ssh            # 700
ls -l ~/.ssh/authorized_keys  # 600
```

### D√©sactiver les mots de passe (apr√®s v√©rif)

Dans `/etc/ssh/sshd_config` :

```ini
PasswordAuthentication no
ChallengeResponseAuthentication no
```

Puis :

```bash
sudo systemctl restart ssh
```

---
</details>
<details>
<summary>

## 4 ‚Äî Connexion & ergonomie
</summary>

### Connexion de base

```bash
ssh user@IP_ou_nom_de_domaine
```

### Options utiles

* `ssh -p 2222 user@host` ‚Äî port personnalis√©
* `ssh -v user@host` ‚Äî mode verbeux (d√©bogage)
* `ssh -A user@host` ‚Äî forwarding agent (attention s√©curit√©)

### Alias pour connexions fr√©quentes (`~/.ssh/config` c√¥t√© client)

Exemple :

```ini
Host monserveur
  HostName srv.exemple.com
  User admin
  Port 2222
  IdentityFile ~/.ssh/id_rsa_personnel
```

Puis : `ssh monserveur`

---
</details>
<details>
<summary>

## 5 ‚Äî Transfert de fichiers
</summary>

### `scp` (simple)

Copier local -> serveur :

```bash
scp fichier.txt user@server:/home/user/
```

Serveur -> local :

```bash
scp user@server:/home/user/fichier.txt .
```

### `sftp` (interactif)

```bash
sftp user@server
sftp> put localfile
sftp> get remotefile
sftp> exit
```

### Outils GUI (FileZilla)

* Choisir **SFTP** comme protocole, indiquer host/port/user et (optionnel) cl√© priv√©e (ppk ou cl√© OpenSSH selon config).

---
</details>
<details>
<summary>

## 6 ‚Äî Outils d‚Äôagent et gestion de cl√©s
</summary>

### D√©marrer l‚Äôagent et ajouter une cl√© (session)

```bash
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/id_rsa
```

### Utiliser `ssh-keygen` pour types modernes (ed25519 recommand√©)

```bash
ssh-keygen -t ed25519 -C "email"
```

---
</details>
<details>
<summary>

## 7 ‚Äî Durcissement & bonnes pratiques
</summary>

### Param√®tres recommand√©s (r√©sum√©)

* `PermitRootLogin no`
* `PasswordAuthentication no` (si cl√©s en place)
* `AllowUsers user1 user2` ou `AllowGroups admins`
* `UsePAM yes` (si n√©cessaire pour integration)
* `MaxAuthTries 3`
* `ClientAliveInterval`/`ClientAliveCountMax` pour timeout
* Mettre √† jour OpenSSH r√©guli√®rement.

### Protections compl√©mentaires

* **Fail2ban** : bloque IP apr√®s tentatives r√©p√©t√©es.

  * Installer :

    ```bash
    sudo apt install fail2ban -y
    ```
  * Exemple de jail local `/etc/fail2ban/jail.d/ssh.local` :

    ```ini
    [sshd]
    enabled = true
    port = 22
    logpath = /var/log/auth.log
    maxretry = 5
    ```
  * Red√©marrer fail2ban : `sudo systemctl restart fail2ban`

* **Firewall** (ufw)

  ```bash
  sudo ufw allow 22/tcp        # ou sudo ufw allow 2222/tcp si port modifi√©
  sudo ufw enable
  sudo ufw status
  ```

* **2FA / OTP** (optionnel) : `libpam-google-authenticator` pour MFA.

* Restreindre `ListenAddress` √† IP publique n√©cessaire ou r√©seau interne.

---
</details>
<details>
<summary>

## 8 ‚Äî Forwarding & tunnels utiles
</summary>

* **Port forwarding local** : `ssh -L 8080:localhost:80 user@host` ‚Üí acc√©der √† [http://localhost:8080](http://localhost:8080) redirig√© vers host:80.
* **Remote forwarding** : `ssh -R 2222:localhost:22 user@server` (exposer port local via serveur).
* **Dynamic SOCKS proxy** : `ssh -D 1080 user@host` ‚Üí proxy SOCKS pour navigateur.

---
</details>
<details>
<summary>

## 9 ‚Äî D√©pannage (commands & diagnostics)
</summary>

* Mode verbeux c√¥t√© client :

```bash
  ssh -vvv user@host
  ```
* Logs serveur :

```bash
  sudo journalctl -u ssh -f
  sudo tail -f /var/log/auth.log
  sudo tail -f /var/log/secure   # CentOS/RHEL
  ```
* Tester que sshd √©coute :

```bash
  ss -tlnp | grep sshd
  ```
* V√©rifier configuration sshd :

```bash
  sudo sshd -t   # test syntaxe
  sudo systemctl restart ssh && sudo systemctl status ssh
  ```
* Probl√®me de permission cl√© : v√©rifier `~/.ssh` permissions (700) et `authorized_keys` (600).

---
</details>
<details>
<summary>

## 10 ‚Äî Exemples pratiques (mini-proc√©dures)
</summary>

### A. Mettre en place acc√®s par cl√© (proc√©dure compl√®te)

1. G√©n√©rer cl√© : `ssh-keygen -t ed25519 -C "email"`
2. Copier cl√© : `ssh-copy-id user@ip`
3. Tester connexion : `ssh user@ip`
4. Si OK, verrouiller mot de passe : √©diter `/etc/ssh/sshd_config` ‚Üí `PasswordAuthentication no` ‚Üí `sudo systemctl restart ssh`

### B. Autoriser seulement un groupe

Dans `/etc/ssh/sshd_config` :

```ini
AllowGroups sshusers
```

Cr√©er groupe et ajouter utilisateur :

```bash
sudo groupadd sshusers
sudo usermod -aG sshusers user
```

### C. D√©ployer fail2ban basic

```bash
sudo apt install fail2ban -y
# cr√©er /etc/fail2ban/jail.d/defaults-debian.conf puis restart
sudo systemctl restart fail2ban
sudo fail2ban-client status sshd
```

---
</details>
<details>
<summary>

## 11 ‚Äî Tableaux synth√©tiques
</summary>

### Comparatif authentification

| M√©thode      |    S√©curit√© | Avantage                    | Inconv√©nient                |
| ------------ | ----------: | --------------------------- | --------------------------- |
| Mot de passe |     Moyenne | Simplicit√©                  | Bruteforce possible         |
| Cl√©s SSH     |      √âlev√©e | Sans mot de passe, plus s√ªr | Gestion des cl√©s            |
| 2FA + Cl√©s   | Tr√®s √©lev√©e | D√©fense en profondeur       | Complexit√© d‚Äôimpl√©mentation |

---
</details>
<details>
<summary>

## 12 ‚Äî Liens & ressources
</summary>

* OpenSSH : [https://www.openssh.com/](https://www.openssh.com/)
* Debian/Ubuntu SSH : [https://wiki.debian.org/SSH](https://wiki.debian.org/SSH) & [https://help.ubuntu.com/community/SSH](https://help.ubuntu.com/community/SSH)
* Fail2ban : [https://www.fail2ban.org/](https://www.fail2ban.org/)
* Tutoriels pratiques : pages man (`man ssh`, `man sshd_config`, `man ssh-keygen`)

---
</details>
<details>
<summary>

## ‚úÖ R√©sum√© ‚Äî Ce qu‚Äôil faut retenir
</summary>

* **Pr√©f√©rence : cl√©s SSH** plut√¥t que mots de passe.
* Prot√©ger les cl√©s (`chmod 600`) et restreindre `sshd_config` (disable root, limiter users, fermer PasswordAuthentication).
* **Fail2ban + firewall** = couche anti-bruteforce efficace.
* Utiliser `ssh -vvv`, `journalctl`, `ss -tlnp` pour diagnostiquer.
* Sauvegarder les configs avant modification et pr√©voir un plan d‚Äôacc√®s d‚Äôurgence (acc√®s console ou VPN) si on verrouille l‚Äôacc√®s SSH.

---
</details>